
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // UTILITY FUNCTIONS
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      // Caches the user document read for the entire rule evaluation.
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userRole() {
      return isSignedIn() ? userDoc().data.role : null;
    }

    function isRole(role) {
      return userRole() == role;
    }

    function isAdmin() {
      return isRole('Admin');
    }

    function isManagingEditor() {
      return isRole('Managing Editor');
    }

    function isEditor() {
      return isRole('Editor');
    }

    function isReviewer() {
      return isRole('Reviewer');
    }

    function isAuthor() {
      return isRole('Author');
    }
    
    function isEditorialMember() {
      return isEditor() || isManagingEditor() || isAdmin();
    }

    // -------------------------------------------------------------------------
    // USERS COLLECTION
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow read: if true; // Public profiles
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if (
        // Allow user to edit their own profile, but not their role
        (isSignedIn() && request.auth.uid == userId && request.resource.data.role == resource.data.role)
        // Allow Admin/Managing Editor to update any user profile, including role
        || isAdmin() || isManagingEditor()
      );
    }

    // -------------------------------------------------------------------------
    // SUBMISSIONS COLLECTION
    // -------------------------------------------------------------------------

    match /submissions/{submissionId} {

      // The 'list' rule is combined with client-side queries.
      // Firestore security rules are not filters, they are verifiers.
      // This rule works with queries that filter by author.id or reviewerIds.
      allow list: if isSignedIn();

      // Read a single submission document
      allow get: if isSignedIn() && (
        resource.data.author.id == request.auth.uid || // Author can get their own
        request.auth.uid in resource.data.reviewerIds || // Assigned reviewer can get
        isEditorialMember() // Editorial staff can get any
      );

      // Create a new submission
      allow create: if isAuthor() || isEditorialMember();

      // Update a submission
      allow update: if (
        // Editorial staff can update anything
        isEditorialMember() ||
        // Author resubmission flow
        (
          isAuthor() &&
          request.auth.uid == resource.data.author.id &&
          (resource.data.status == 'Minor Revision' || resource.data.status == 'Major Revision') &&
          request.resource.data.keys().hasOnly(['manuscriptUrl', 'status']) &&
          request.resource.data.status == 'Under Initial Review'
        )
      );

      // Delete a submission
      allow delete: if isEditorialMember();

      // --- REVIEWS SUBCOLLECTION ---
      match /reviews/{reviewId} {
        allow read: if (
          isEditorialMember() ||
          // Authors can read reviews ONLY when revision is requested
          (isAuthor() &&
           get(/databases/$(database)/documents/submissions/$(submissionId)).data.author.id == request.auth.uid &&
           get(/databases/$(database)/documents/submissions/$(submissionId)).data.status in ['Minor Revision', 'Major Revision'])
        );
        allow create: if (
          isReviewer() &&
          request.auth.uid in get(/databases/$(database)/documents/submissions/$(submissionId)).data.reviewerIds
        );
      }

      // --- HISTORY SUBCOLLECTION ---
      match /history/{historyId} {
        allow read: if (
          isEditorialMember() ||
          get(/databases/$(database)/documents/submissions/$(submissionId)).data.author.id == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/submissions/$(submissionId)).data.reviewerIds
        );
        allow write: if isEditorialMember();
      }
    }
    
    // -------------------------------------------------------------------------
    // NOTIFICATIONS COLLECTION
    // -------------------------------------------------------------------------
    
    match /notifications/{notificationId} {
      // Users can query for their own notifications.
      // The client-side query MUST include `where('userId', '==', request.auth.uid)`.
      allow list: if isSignedIn() && request.query.filters[0][2] == request.auth.uid;
      
      // Users can only read their own notifications.
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Notifications are created by server-side logic (flows).
      allow create: if true;
      
      // A user can only update the 'read' status of their own notification.
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid && request.resource.data.keys().hasOnly(['read']);
    }

    // -------------------------------------------------------------------------
    // VOLUMES (PUBLISHED ARCHIVE)
    // -------------------------------------------------------------------------

    match /volumes/{volumeId} {
      allow read: if true; // Publicly readable archive
      allow write: if isManagingEditor() || isAdmin();
    }

    // -------------------------------------------------------------------------
    // EDITORIAL BOARD
    // -------------------------------------------------------------------------

    match /editorialBoard/{memberId} {
      allow read: if true; // Publicly readable
      allow write: if isManagingEditor() || isAdmin();
    }

    // -------------------------------------------------------------------------
    // SETTINGS (BRANDING, JOURNAL INFO, ETC.)
    // -------------------------------------------------------------------------

    match /settings/{settingId} {
      allow read: if true; // Publicly readable for client-side display
      allow write: if isManagingEditor() || isAdmin();
    }
  }
}
