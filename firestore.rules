
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // UTILITY FUNCTIONS
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userRole() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? userDoc().data.role : null;
    }

    function isRole(role) {
      return userRole() == role;
    }

    function isAdmin() {
      return isRole('Admin');
    }

    function isManagingEditor() {
      return isRole('Managing Editor');
    }

    function isEditor() {
      return isRole('Editor');
    }

    function isReviewer() {
      return isRole('Reviewer');
    }

    function isAuthor() {
      return isRole('Author');
    }
    
    function isEditorialMember() {
      return isAdmin() || isManagingEditor() || isEditor();
    }

    // -------------------------------------------------------------------------
    // USERS COLLECTION
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow read: if true; // Public profiles
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if (
        // Users can edit their own profile except 'role'
        (isSignedIn() && request.auth.uid == userId && request.resource.data.role == resource.data.role)
        // Admin/Managing Editor can update anything
        || isAdmin() || isManagingEditor()
      );
    }

    // -------------------------------------------------------------------------
    // SUBMISSIONS COLLECTION
    // -------------------------------------------------------------------------

    match /submissions/{submissionId} {
      
      allow list: if isSignedIn();

      allow get: if isSignedIn() && (
        resource.data.author.id == request.auth.uid ||
        request.auth.uid in resource.data.reviewerIds ||
        isEditorialMember()
      );

      allow create: if isAuthor() || isEditorialMember();

      allow update: if (
        isEditorialMember() ||
        (
          isAuthor() &&
          request.auth.uid == resource.data.author.id &&
          (resource.data.status == 'Minor Revision' || resource.data.status == 'Major Revision') &&
          request.resource.data.keys().hasOnly(['manuscriptUrl', 'status']) &&
          request.resource.data.status == 'Under Initial Review'
        )
      );

      allow delete: if isEditorialMember();

      // --- REVIEWS SUBCOLLECTION ---
      match /reviews/{reviewId} {
        allow read: if (
          isEditorialMember() ||
          (
            isAuthor() &&
            exists(/databases/$(database)/documents/submissions/$(submissionId)) &&
            get(/databases/$(database)/documents/submissions/$(submissionId)).data.author.id == request.auth.uid &&
            get(/databases/$(database)/documents/submissions/$(submissionId)).data.status in ['Minor Revision','Major Revision']
          )
        );
        allow create: if (
          isReviewer() &&
          exists(/databases/$(database)/documents/submissions/$(submissionId)) &&
          request.auth.uid in get(/databases/$(database)/documents/submissions/$(submissionId)).data.reviewerIds
        );
      }

      // --- HISTORY SUBCOLLECTION ---
      match /history/{historyId} {
        allow read: if (
          isEditorialMember() ||
          (
            exists(/databases/$(database)/documents/submissions/$(submissionId)) &&
            (
              get(/databases/$(database)/documents/submissions/$(submissionId)).data.author.id == request.auth.uid ||
              request.auth.uid in get(/databases/$(database)/documents/submissions/$(submissionId)).data.reviewerIds
            )
          )
        );
        allow write: if isEditorialMember();
      }
    }

    // -------------------------------------------------------------------------
    // NOTIFICATIONS COLLECTION
    // -------------------------------------------------------------------------

    match /notifications/{notificationId} {
      // Users can query their own notifications.
      allow list: if isSignedIn(); // Client must filter by userId

      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;

      // This is safe because flows can only be triggered by authenticated users with correct roles.
      // And flows construct the notification with the correct userId
      allow create: if isSignedIn();
      
      // Users can only update 'read' status of their own notifications
      allow update: if isSignedIn() &&
                    resource.data.userId == request.auth.uid &&
                    request.resource.data.keys().hasOnly(['read']);
    }

    // -------------------------------------------------------------------------
    // VOLUMES COLLECTION
    // -------------------------------------------------------------------------

    match /volumes/{volumeId} {
      allow read: if true;
      allow write: if isAdmin() || isManagingEditor();
    }

    // -------------------------------------------------------------------------
    // EDITORIAL BOARD
    // -------------------------------------------------------------------------

    match /editorialBoard/{memberId} {
      allow read: if true;
      allow write: if isAdmin() || isManagingEditor();
    }

    // -------------------------------------------------------------------------
    // SETTINGS COLLECTION
    // -------------------------------------------------------------------------

    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin() || isManagingEditor();
    }
  }
}
